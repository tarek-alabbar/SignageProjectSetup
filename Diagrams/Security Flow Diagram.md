[![](https://mermaid.ink/img/pako:eNqNVm1TIjkQ_itd8-HUOhRRFJ268grFc9nadTlxlqorv4SZFlIOyVySUVmK_36dZAZmgL3VDwLpl3Q__fRTWQSxTDAIA43_5ihi7HE2UWz2JID-MqYMj3nGhIEImIZIo9o2jaxphGPNDW5bu9baHfS3LT1r6THDxkzvCBxY8yBl8_JO__9eGgT5igqixiCEbm6mKCiIGS4F_JXKt6p3dHh1NQrhVhgKiBUm1pel2ltHZO2GMPg2fIQmy3iTUbZmKidc_DFWzasFzhhPG1SW1m9SJUsf1qWwXgh_56jmkBMmMJ6Dc_X23qHPa-EChTFFwhs301WeT0xP16nI8_pGzTNz9B0Vf57vl24NmJLjQbUflhr4zlKewKBw8ueVXHcoUDEC6fPoEYx8Qd_LTcr4TIeu3j6ldvU6y-17xhWS6aQNU5krXU3p8Vu4PEUQffiIrlmuXUfeM5UxS4dGKjbBI42mb3C2v-fC9xq-nKIhTDVCX7z-tBufsH3cgkjYwUjFf2BSvZE8ohCGU_kGqJQseIIi-RhhMLHEhAfLfW30Dt50Y8eq_TxLJSPQiEEWWR1PMclTPKjRqJLL4foJWYLK32hr9wy9RqaoFo_ossYCN9gdk5ti_AKaTwQzucIC_vluWjzasC1O3L4bxWJTDB-elZz5CyB2tKgHrLjtSFvG8NSUm7hJ8j0NVDcDKdL59gSHeRyj1rQJOpOiXPXq-Juegjuq_zUHnMNNSqjWuLdNkwdM6A4CwUhwK_4Rtnj92VCZqv9gU0IyF9EktPkrzdLriFXZBiT4ymOMcr4hJKu5Z4wrLiZg3etSckMn4FflNxDSFCuY1PJ84eKlcoltNC-m4w5LZ_Km1hbaz6Wsq19WNfD23Zu8Tk_rnNPHwQfQqywZ7N9Ly--DHSDe3dYxLNesufgZcp6m3mpFOIr6vTpwPW97lrmw0FmEN1C7Q7NaaPJTYKa8jliZa1h6WbLXwVyZPg-_3f8PItepHEMBKgwxzhU3tU0utKSAC2ZEWgbRw5eaUKwkftgdVoSiEHLgAlpOyd3pA8nQod1MyFDNuNYrBpfr5YqiO-D3dcJ1NdbqZ7MY09dIpcs_F5rpx4qAWZ8i2VdXMakF7pjwVluu2BL9X_So3XRYmvrw-gBcLqdXa__11b6HnnwTVsc3_OotDKot6KARTBRPgtCoHBvBjBBk9mewsFFPAcnCDJ-CkL4mTL08BU9iSTH0gPlHylkZpmQ-mQbhMz086Fee2WUvXlorF9IhVDdEUxOE7faZyxGEi-A9CFsX50enl-fnrdbFcafdabcbwZxOj0-P2q2zk7NW5_T0rNW67CwbwQ9368lR--z4pNO5PG11Ohed84vzRkA9Ee2--ueee_Ut_wN2Nx5H?type=png)](https://mermaid.live/edit#pako:eNqNVm1TIjkQ_itd8-HUOhRRFJ268grFc9nadTlxlqorv4SZFlIOyVySUVmK_36dZAZmgL3VDwLpl3Q__fRTWQSxTDAIA43_5ihi7HE2UWz2JID-MqYMj3nGhIEImIZIo9o2jaxphGPNDW5bu9baHfS3LT1r6THDxkzvCBxY8yBl8_JO__9eGgT5igqixiCEbm6mKCiIGS4F_JXKt6p3dHh1NQrhVhgKiBUm1pel2ltHZO2GMPg2fIQmy3iTUbZmKidc_DFWzasFzhhPG1SW1m9SJUsf1qWwXgh_56jmkBMmMJ6Dc_X23qHPa-EChTFFwhs301WeT0xP16nI8_pGzTNz9B0Vf57vl24NmJLjQbUflhr4zlKewKBw8ueVXHcoUDEC6fPoEYx8Qd_LTcr4TIeu3j6ldvU6y-17xhWS6aQNU5krXU3p8Vu4PEUQffiIrlmuXUfeM5UxS4dGKjbBI42mb3C2v-fC9xq-nKIhTDVCX7z-tBufsH3cgkjYwUjFf2BSvZE8ohCGU_kGqJQseIIi-RhhMLHEhAfLfW30Dt50Y8eq_TxLJSPQiEEWWR1PMclTPKjRqJLL4foJWYLK32hr9wy9RqaoFo_ossYCN9gdk5ti_AKaTwQzucIC_vluWjzasC1O3L4bxWJTDB-elZz5CyB2tKgHrLjtSFvG8NSUm7hJ8j0NVDcDKdL59gSHeRyj1rQJOpOiXPXq-Juegjuq_zUHnMNNSqjWuLdNkwdM6A4CwUhwK_4Rtnj92VCZqv9gU0IyF9EktPkrzdLriFXZBiT4ymOMcr4hJKu5Z4wrLiZg3etSckMn4FflNxDSFCuY1PJ84eKlcoltNC-m4w5LZ_Km1hbaz6Wsq19WNfD23Zu8Tk_rnNPHwQfQqywZ7N9Ly--DHSDe3dYxLNesufgZcp6m3mpFOIr6vTpwPW97lrmw0FmEN1C7Q7NaaPJTYKa8jliZa1h6WbLXwVyZPg-_3f8PItepHEMBKgwxzhU3tU0utKSAC2ZEWgbRw5eaUKwkftgdVoSiEHLgAlpOyd3pA8nQod1MyFDNuNYrBpfr5YqiO-D3dcJ1NdbqZ7MY09dIpcs_F5rpx4qAWZ8i2VdXMakF7pjwVluu2BL9X_So3XRYmvrw-gBcLqdXa__11b6HnnwTVsc3_OotDKot6KARTBRPgtCoHBvBjBBk9mewsFFPAcnCDJ-CkL4mTL08BU9iSTH0gPlHylkZpmQ-mQbhMz086Fee2WUvXlorF9IhVDdEUxOE7faZyxGEi-A9CFsX50enl-fnrdbFcafdabcbwZxOj0-P2q2zk7NW5_T0rNW67CwbwQ9368lR--z4pNO5PG11Ohed84vzRkA9Ee2--ueee_Ut_wN2Nx5H)

**Mermaid code:**

```
sequenceDiagram
    participant U as User
    participant W as Website
    participant A as API
    participant D as Database
    participant P as Player

    Note over U,P: Authentication Flow

    U->>W: Enter credentials
    W->>A: POST /api/auth/login<br/>{email, password}
    A->>D: Query user by email
    D-->>A: User record with passwordHash
    A->>A: BCrypt.Verify(password, hash)

    alt Valid Password
        A->>A: Generate JWT token<br/>Claims: userId, email<br/>Expires: 24 hours
        A-->>W: {token, email, expiresAt}
        W->>W: localStorage.setItem('token', token)
    else Invalid Password
        A-->>W: 401 Unauthorized
        W-->>U: Show error
    end

    Note over U,P: Authenticated API Requests

    U->>W: Action (upload, create schedule)
    W->>A: API Request<br/>Header: Authorization Bearer {token}
    A->>A: Validate JWT token<br/>Check signature, expiry

    alt Valid Token
        A->>A: Extract userId from token claims
        A->>D: Query with userId filter
        D-->>A: User's data only
        A-->>W: Success response
    else Invalid/Expired Token
        A-->>W: 401 Unauthorized
        W->>W: Clear localStorage
        W-->>U: Redirect to login
    end

    Note over U,P: Player Authentication

    P->>A: POST /api/player/activate<br/>{code, deviceUuid}
    A->>D: Validate pairing code
    D-->>A: Code valid & not expired
    A->>D: Link deviceUuid to user's device
    A-->>P: {success, deviceId}
    P->>P: localStorage.setItem('deviceUuid', uuid)

    Note over U,P: Player API Requests (No JWT)

    P->>A: GET /api/player/schedule/{deviceUuid}
    A->>D: Query device by UUID
    D-->>A: Device found & paired
    A->>D: Get schedule for this device
    D-->>A: Schedule data
    A-->>P: Schedule JSON

    Note over U,P: Blob Storage Security

    W->>A: Request media URL
    A->>A: Generate SAS token<br/>Expires in 1 hour<br/>Read-only permission
    A-->>W: Blob URL + SAS token
    W->>Blob: GET {blobUrl}?{sasToken}
    Blob-->>W: Media file

    P->>A: Request media URLs in schedule
    A->>A: Generate SAS tokens for all media
    A-->>P: URLs with SAS tokens
    P->>Blob: Download with SAS token
    Blob-->>P: Media files
```
